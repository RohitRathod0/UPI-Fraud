<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SecureUPI • Pay</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0f1f;
    --grad1:#5b6ee1;
    --grad2:#7c4bd8;
    --card:#0f172a;
    --pane:#111a33;
    --stroke:#1e293b;
    --ink:#e2e8f0;
    --muted:#94a3b8;
    --ok:#22c55e;
    --warn:#f59e0b;
    --block:#ef4444;
    --accent:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{
    width:100%;height:100%;overflow-x:hidden;
  }
  body{
    margin:0;background:linear-gradient(180deg,#0b1224 0%, #0a0f1f 100%);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);
    min-height:100vh;
  }
  .appbar{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(90deg,var(--grad1),var(--grad2));
    padding:14px 18px;display:flex;align-items:center;gap:12px;
    box-shadow:0 8px 30px rgba(0,0,0,.35);
    width:100%;
  }
  .brand{
    width:38px;height:38px;border-radius:12px;background:rgba(255,255,255,.16);
    display:grid;place-items:center;font-weight:900;color:#fff;
    flex-shrink:0;
  }
  .title{font-weight:900;font-size:18px;color:#fff}
  .subtitle{font-size:12px;color:#eaf2ff;opacity:.9}
  /* LAYOUT FIXES */
  .wrap{
    max-width:1200px;               /* wider canvas */
    width:100%;
    margin:22px auto;
    padding:0 16px;
    display:grid;
    grid-template-columns: minmax(0, 420px) minmax(0, 1fr);/* stable left width with overflow protection */
    gap:22px;                        /* more breathing room */
    align-items:start;               /* align cards to top */
  }
  @media (max-width: 980px){
    .wrap{ 
      grid-template-columns: 1fr; 
      padding:0 12px;
    }
  }
  .card{
    background:linear-gradient(180deg,#0f162e, #0d1326);
    border:1px solid var(--stroke);border-radius:16px;
    box-shadow:0 12px 50px rgba(0,0,0,.35);
    width:100%;
    min-width:0;                     /* prevent grid overflow */
    overflow:hidden;
  }
  .pane{
    padding:20px;
    width:100%;
    min-width:0;
  }
  @media (max-width: 520px){
    .pane{padding:16px}
  }
  .section-title{
    font-size:14px;color:var(--muted);font-weight:800;
    text-transform:uppercase;letter-spacing:.06em;margin:0 0 12px;
  }

  /* FORM GRID TUNING */
  .form{
    display:grid;
    grid-template-columns:1fr;
    gap:14px;
    width:100%;
    min-width:0;
  }
  .row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:14px;
    width:100%;
    min-width:0;
  }
  @media (max-width: 520px){ 
    .row{
      grid-template-columns:1fr; 
    } 
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:0;
    width:100%;
  }
  .label{
    font-size:12px;
    font-weight:700;
    color:var(--muted);
    letter-spacing:.02em;
  }
  .input,.select,.textarea{
    appearance:none;
    background:#0b132a;
    border:1px solid var(--stroke);
    border-radius:12px;
    color:var(--ink);
    padding:14px 14px;
    font:inherit;
    outline:none;
    transition:.2s;
    width:100%;
    min-width:0;
    max-width:100%;
  }
  .input:focus,.select:focus,.textarea:focus{
    border-color:#6080ff;
    box-shadow:0 0 0 4px rgba(96,128,255,.18);
  }
  .textarea{
    min-height:92px;
    resize:vertical;
  }

  /* BUTTONS SPACING */
  .actions{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:6px;
    width:100%;
  }
  .btn{
    border:none;
    border-radius:12px;
    padding:12px 14px;
    font-weight:900;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:8px;
    white-space:nowrap;
    flex-shrink:0;
  }
  @media (max-width: 520px){
    .btn{
      flex:1 1 auto;
      min-width:0;
      justify-content:center;
    }
  }
  .btn-primary{background:linear-gradient(135deg,var(--grad1),var(--grad2));color:#fff}
  .btn-ghost{background:#0b132a;border:1px solid var(--stroke);color:#e2e8f0}

  .hint{
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
    word-wrap:break-word;
  }

  /* RESULT SIDE TUNING */
  .kpi{
    display:flex;
    align-items:center;
    gap:14px;
    margin-bottom:8px;
    flex-wrap:wrap;
    width:100%;
  }
  .score{
    font-weight:900;
    font-size:54px;
    line-height:1;
    flex-shrink:0;
  }
  @media (max-width: 520px){
    .score{font-size:42px;}
  }
  .pill{
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    color:#fff;
    display:inline-block;
    white-space:nowrap;
  }
  .pill-ok{background:var(--ok)} 
  .pill-warn{background:var(--warn)} 
  .pill-block{background:var(--block)}

  /* Cards inside result arranged better on small widths */
  .grid2{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:14px;
    margin-top:12px;
    width:100%;
    min-width:0;
  }
  @media (max-width: 720px){ 
    .grid2{
      grid-template-columns:1fr; 
    } 
  }

  .stat{
    padding:14px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:#0b132a;
    color:#e2e8f0;
    width:100%;
    min-width:0;
  }
  .stat-label{
    font-weight:800;
    color:#e2e8f0;
    word-wrap:break-word;
  }
  .bar{
    height:8px;
    background:#0e1a33;
    border-radius:999px;
    overflow:hidden;
    margin-top:8px;
    width:100%;
  }
  .fill{
    height:100%;
    width:0;
    background:linear-gradient(90deg,var(--grad1),var(--grad2));
    transition:.4s;
  }

  .box{
    padding:16px;
    border:1px solid var(--stroke);
    border-radius:14px;
    background:#0b132a;
    margin-top:14px;
    width:100%;
    min-width:0;
    overflow-wrap:break-word;
  }
  .json{
    font-family:ui-monospace,Consolas,Monaco,monospace;
    font-size:12px;
    color:#d7e2ff;
    white-space:pre-wrap;
    word-wrap:break-word;
    overflow-wrap:break-word;
    max-width:100%;
  }

  /* Chips row spacing and contrast */
  .chips{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    width:100%;
  }
  .chip{
    padding:6px 10px;
    border:1px solid var(--stroke);
    border-radius:999px;
    background:#0b132a;
    color:#cbd5e1;
    font-size:12px;
    font-weight:700;
    cursor:pointer;
    white-space:nowrap;
    flex-shrink:0;
  }
  .chip.active{
    border-color:#6080ff;
    box-shadow:0 0 0 3px rgba(96,128,255,.15);
  }

  /* Minor visual alignment fix for the two main cards */
  .card .pane > *:last-child{margin-bottom:0}

  /* Toast notification */
  #toast{
    position:fixed;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    background:#0b132a;
    border:1px solid #1e293b;
    color:#e2e8f0;
    border-radius:10px;
    padding:10px 14px;
    display:none;
    font-size:12px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);
    z-index:1000;
    max-width:calc(100% - 32px);
    word-wrap:break-word;
    pointer-events:none;
  }
</style>
</head>
<body>
  <header class="appbar">
    <div class="brand">₹</div>
    <div>
      <div class="title">SecureUPI</div>
      <div class="subtitle">AI‑Protected Payments •</div>
    </div>
  </header>

  <div class="wrap">
    <!-- Left: Payment card -->
    <div class="card">
      <div class="pane">
        <div class="section-title">Pay Securely</div>

        <!-- Quick chips -->
        <div class="chips" id="chips">
          <div class="chip active" data-amt="500">₹500</div>
          <div class="chip" data-amt="1000">₹1,000</div>
          <div class="chip" data-amt="5000">₹5,000</div>
          <div class="chip" data-amt="10000">₹10,000</div>
          <div class="chip" data-amt="20000">₹20,000</div>
        </div>

        <div class="form" style="margin-top:12px">
          <div class="row">
            <div class="field">
              <label class="label">Payer UPI ID</label>
              <input class="input" id="payer_vpa" placeholder="you@bank" value="vikas@paytm">
            </div>
            <div class="field">
              <label class="label">Payee UPI ID</label>
              <input class="input" id="payee_vpa" placeholder="merchant@upi" value="vansh@upi">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label class="label">Mobile Number</label>
              <input class="input" id="mobile_number" placeholder="98XXXXXXXX" maxlength="10">
            </div>
            <div class="field">
              <label class="label">Amount (₹)</label>
              <input class="input" id="amount" type="number" min="1" value="8000">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label class="label">Transaction Type</label>
              <select class="select" id="transaction_type">
                <option value="pay" selected>pay</option>
                <option value="qr_pay">qr_pay</option>
                <option value="collect">collect</option>
              </select>
            </div>
            <div class="field">
              <label class="label">Payee New?</label>
              <select class="select" id="payee_new">
                <option value="1" selected>Yes</option>
                <option value="0">No</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label class="label">Message / Note *</label>
            <textarea class="textarea" id="message" required placeholder="Add a note for the payment">URGENT! Account locked. Verify PIN at http://fake-bank-verify.com</textarea>
          </div>

          <div class="actions">
            <button class="btn btn-primary" id="payBtn">Run AI Security Check</button>
            <button class="btn btn-ghost" id="safe">Safe</button>
            <button class="btn btn-ghost" id="phish">Phishing</button>
            <button class="btn btn-ghost" id="qr">QR Scam</button>
            <button class="btn btn-ghost" id="collect">Collect</button>
          </div>

          <div class="hint">Your details are analyzed locally then sent securely to the server for trust scoring.</div>
        </div>
      </div>
    </div>

    <!-- Right: Result card -->
    <div class="card">
      <div class="pane">
        <div class="section-title">Result</div>
        <div class="kpi">
          <div class="score" id="trust">—</div>
          <div class="pill pill-ok" id="action">Action: —</div>
        </div>

        <div class="grid2">
          <div class="stat">
            <div class="stat-label">Phishing</div>
            <div class="bar"><div id="b-phish" class="fill"></div></div>
          </div>
          <div class="stat">
            <div class="stat-label">Quishing (QR)</div>
            <div class="bar"><div id="b-qr" class="fill"></div></div>
          </div>
          <div class="stat">
            <div class="stat-label">Collect Fraud</div>
            <div class="bar"><div id="b-collect" class="fill"></div></div>
          </div>
          <div class="stat">
            <div class="stat-label">Malware</div>
            <div class="bar"><div id="b-mal" class="fill"></div></div>
          </div>
        </div>

        <!-- Risk Visualization Section -->
        <div class="box" id="riskVizBox" style="display:none; margin-top:14px;">
          <div class="section-title" style="margin:0 0 12px">Risk Analysis</div>
          
          <!-- Risk Meter -->
          <div style="margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <span style="font-size:13px; color:var(--muted); font-weight:600;">Overall Risk Level</span>
              <span id="riskLevel" style="font-size:12px; font-weight:700; padding:4px 10px; border-radius:6px; background:#0e1a33;"></span>
            </div>
            <div class="bar" style="height:12px; margin-top:8px;">
              <div id="riskMeter" class="fill" style="transition:width 0.6s ease, background 0.6s;"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:var(--muted);">
              <span>Low Risk</span>
              <span>High Risk</span>
            </div>
          </div>

          <!-- Charts Container -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:16px;">
            <div>
              <div style="font-size:12px; color:var(--muted); font-weight:600; margin-bottom:8px;">Risk Breakdown</div>
              <canvas id="riskPieChart" style="max-height:150px;"></canvas>
            </div>
            <div>
              <div style="font-size:12px; color:var(--muted); font-weight:600; margin-bottom:8px;">Feature Importance</div>
              <canvas id="featureBarChart" style="max-height:150px;"></canvas>
            </div>
          </div>
        </div>

        <div class="box">
          <div class="section-title" style="margin:0 0 6px">Reasons</div>
          <div id="reasons" class="json">—</div>
        </div>
      </div>
    </div>
  </div>

<!-- Optional toast for confirmations -->
<div id="toast"></div>

<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  const API_URL = (location.hostname==='127.0.0.1' || location.hostname==='localhost')
      ? 'http://127.0.0.1:8000/api/v1/score_request' : '/api/v1/score_request';

  const $ = id => document.getElementById(id);
  const chips = document.getElementById('chips');
  chips.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('chip')) return;
    [...chips.children].forEach(c=>c.classList.remove('active'));
    e.target.classList.add('active');
    $('amount').value = e.target.dataset.amt;
  });

  const fill = (t,v)=>{ $(t).style.width = Math.max(0,Math.min(100,v)) + '%'; };
  const setAction = a=>{
    const el=$('action'); el.textContent='Action: ' + (a||'—');
    el.className='pill ' + (a==='ALLOW'?'pill-ok':a==='WARN'?'pill-warn':'pill-block');
  };
  const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',2000);};

  // Presets
  $('safe').onclick=()=>load({
    payer_vpa:'vikas@paytm',payee_vpa:'grocery-store@paytm',mobile_number:'9876543210',
    amount:450,transaction_type:'pay',payee_new:'0',message:'Weekly groceries'
  });
  $('phish').onclick=()=>load({
    payer_vpa:'vikas@paytm',payee_vpa:'verify-security@upi',mobile_number:'9876543210',
    amount:15000,transaction_type:'pay',payee_new:'1',message:'URGENT! Account locked. Verify PIN at http://fake-bank.com'
  });
  $('qr').onclick=()=>load({
    payer_vpa:'vikas@paytm',payee_vpa:'prize-claim@paytm',mobile_number:'9876543210',
    amount:19999,transaction_type:'qr_pay',payee_new:'1',message:'Scan QR to claim ₹50,000 prize at http://bit.ly/win'
  });
  $('collect').onclick=()=>load({
    payer_vpa:'vikas@paytm',payee_vpa:'legal-dept@upi',mobile_number:'9876543210',
    amount:12000,transaction_type:'collect',payee_new:'1',message:'FINAL NOTICE: Pay dues immediately or legal action'
  });
  function load(m){
    $('payer_vpa').value=m.payer_vpa; $('payee_vpa').value=m.payee_vpa;
    $('mobile_number').value=m.mobile_number||''; $('amount').value=m.amount;
    $('transaction_type').value=m.transaction_type; $('payee_new').value=m.payee_new;
    $('message').value=m.message;
  }

  // Chart instances
  let riskPieChart = null;
  let featureBarChart = null;

  function updateRiskVisualization(data) {
    const riskBreakdown = data.risk_breakdown;
    const featureImportance = data.feature_importance || [];
    
    if (!riskBreakdown || !riskBreakdown.risk_breakdown) {
      document.getElementById('riskVizBox').style.display = 'none';
      return;
    }

    // Show visualization box
    document.getElementById('riskVizBox').style.display = 'block';

    // Update risk meter
    const riskPct = riskBreakdown.risk_percentage || (100 - data.trust_score);
    const riskMeter = $('riskMeter');
    riskMeter.style.width = riskPct + '%';
    
    // Color based on risk
    if (riskPct < 20) {
      riskMeter.style.background = 'linear-gradient(90deg, #22c55e, #16a34a)';
    } else if (riskPct < 40) {
      riskMeter.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
    } else if (riskPct < 70) {
      riskMeter.style.background = 'linear-gradient(90deg, #f97316, #ea580c)';
    } else {
      riskMeter.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
    }

    // Update risk level badge
    const riskLevel = riskBreakdown.risk_level || 'UNKNOWN';
    const riskLevelEl = $('riskLevel');
    riskLevelEl.textContent = riskLevel;
    if (riskPct < 20) {
      riskLevelEl.style.background = 'rgba(34, 197, 94, 0.2)';
      riskLevelEl.style.color = '#22c55e';
    } else if (riskPct < 40) {
      riskLevelEl.style.background = 'rgba(245, 158, 11, 0.2)';
      riskLevelEl.style.color = '#f59e0b';
    } else if (riskPct < 70) {
      riskLevelEl.style.background = 'rgba(249, 115, 22, 0.2)';
      riskLevelEl.style.color = '#f97316';
    } else {
      riskLevelEl.style.background = 'rgba(239, 68, 68, 0.2)';
      riskLevelEl.style.color = '#ef4444';
    }

    // Risk Breakdown Pie Chart
    const breakdown = riskBreakdown.risk_breakdown || {};
    const pieCtx = document.getElementById('riskPieChart').getContext('2d');
    
    if (riskPieChart) riskPieChart.destroy();
    
    const pieData = {
      labels: Object.keys(breakdown).map(k => {
        const labels = {
          'phishing': 'Phishing',
          'quishing': 'Quishing',
          'collect': 'Collect',
          'malware': 'Malware'
        };
        return labels[k] || k;
      }),
      datasets: [{
        data: Object.values(breakdown),
        backgroundColor: [
          'rgba(239, 68, 68, 0.8)',   // Red for phishing
          'rgba(249, 115, 22, 0.8)',  // Orange for quishing
          'rgba(245, 158, 11, 0.8)',  // Amber for collect
          'rgba(220, 38, 127, 0.8)'   // Pink for malware
        ],
        borderColor: [
          '#ef4444',
          '#f97316',
          '#f59e0b',
          '#dc267f'
        ],
        borderWidth: 2
      }]
    };

    riskPieChart = new Chart(pieCtx, {
      type: 'doughnut',
      data: pieData,
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.label + ': ' + context.parsed.toFixed(1) + '%';
              }
            }
          }
        }
      }
    });

    // Feature Importance Bar Chart
    if (featureImportance.length > 0) {
      const barCtx = document.getElementById('featureBarChart').getContext('2d');
      
      if (featureBarChart) featureBarChart.destroy();
      
      const barData = {
        labels: featureImportance.map(f => f.feature || f.feature_key),
        datasets: [{
          label: 'Risk Contribution (%)',
          data: featureImportance.map(f => f.importance || 0),
          backgroundColor: featureImportance.map((f, i) => {
            const colors = ['rgba(239, 68, 68, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(220, 38, 127, 0.7)'];
            return colors[i % colors.length];
          }),
          borderColor: featureImportance.map((f, i) => {
            const colors = ['#ef4444', '#f97316', '#f59e0b', '#dc267f'];
            return colors[i % colors.length];
          }),
          borderWidth: 1
        }]
      };

      featureBarChart = new Chart(barCtx, {
        type: 'bar',
        data: barData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: 'y',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.parsed.x.toFixed(1) + '% risk';
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              ticks: {
                color: '#94a3b8',
                font: { size: 10 }
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.1)'
              }
            },
            y: {
              ticks: {
                color: '#94a3b8',
                font: { size: 10 }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
  }

  $('payBtn').onclick = async ()=>{
    const payload = {
      transaction_id:'TXN-'+Date.now(),
      payer_vpa:$('payer_vpa').value.trim(),
      payee_vpa:$('payee_vpa').value.trim(),
      mobile_number: $('mobile_number').value.trim() || null,
      amount: parseFloat($('amount').value),
      message:$('message').value.trim(),
      transaction_type:$('transaction_type').value,
      payee_new: parseInt($('payee_new').value,10)
    };
    if(!payload.payer_vpa || !payload.payee_vpa || !payload.amount || !payload.message){
      alert('Please fill all required fields'); return;
    }
    if(payload.mobile_number && !/^[6-9]\d{9}$/.test(payload.mobile_number)){
      alert('Enter a valid 10‑digit Indian mobile number'); return;
    }

    try{
      const r = await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data = await r.json();

      $('trust').textContent = data.trust_score ?? '—';
      setAction(data.action);

      const s=data.subscores||{};
      fill('b-phish', (s.phishing??0)*100);
      fill('b-qr', (s.quishing??0)*100);
      fill('b-collect', (s.collect??0)*100);
      fill('b-mal', (s.malware??0)*100);

      const reasons=(data.reasons||[]).map(x=>'• '+x).join('\n');
      $('reasons').textContent = reasons || '—';

      // Update risk visualization
      updateRiskVisualization(data);

      toast(`Decision: ${data.action} • Trust ${data.trust_score}`);
    }catch(err){
      setAction('ERROR');
      toast('Request failed. Check server logs');
      console.error('Error:', err);
    }
  };
</script>
</body>
</html>
